<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>إدارة بطاقة المشتريات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .hidden {
            display: none;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-8">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-6">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">إدارة بطاقة المشتريات</h1>
        
        <!-- ملخص الدورة الحالية -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 text-center font-semibold">
            <div class="bg-blue-100 p-4 rounded-lg shadow-md">
                <p class="text-lg text-blue-800">ديون الدورة الشهرية</p>
                <p id="currentCycleDebt" class="text-2xl text-blue-600 mt-1">0.00 شيكل</p>
            </div>
            <div class="bg-red-100 p-4 rounded-lg shadow-md">
                <p class="text-lg text-red-800">المبلغ المتاح من الراتب</p>
                <p id="remainingBalance" class="text-2xl text-red-600 mt-1">0.00 شيكل</p>
            </div>
            <div class="bg-yellow-100 p-4 rounded-lg shadow-md">
                <p class="text-lg text-yellow-800">إجمالي الأقساط المتبقية</p>
                <p id="totalInstallmentDebt" class="text-2xl text-yellow-600 mt-1">0.00 شيكل</p>
            </div>
        </div>
        
        <!-- قسم جديد لتحليل الإنفاق باستخدام Gemini AI -->
        <div class="bg-purple-50 p-6 rounded-xl shadow-inner mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">تحليل مالي ذكي</h2>
            <p class="text-gray-600 mb-4">
                احصل على ملخص شامل لأنماط إنفاقك ونصائح لتحسين ميزانيتك، كل ذلك بضغطة زر.
            </p>
            <button id="analyzeButton" class="w-full bg-purple-600 text-white py-3 rounded-lg font-bold hover:bg-purple-700 transition duration-300 shadow-md flex items-center justify-center space-x-2">
                <span>تحليل الإنفاق ✨</span>
            </button>
            <div id="analysisResult" class="mt-4 p-4 bg-purple-100 rounded-lg hidden">
                <p id="analysisText" class="text-gray-800 leading-relaxed"></p>
                <div id="loadingIndicator" class="mt-2 text-center hidden">
                    <p class="text-purple-600 flex items-center justify-center space-x-2">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-purple-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        يتم تحليل بياناتك...
                    </p>
                </div>
            </div>
        </div>

        <!-- إضافة حركة جديدة -->
        <div class="bg-gray-50 p-6 rounded-xl shadow-inner mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">إضافة حركة جديدة</h2>
            <form id="transactionForm" class="space-y-4">
                <div>
                    <label for="transactionType" class="block text-gray-700 font-medium mb-1">نوع الحركة</label>
                    <select id="transactionType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="purchase">شراء</option>
                        <option value="online_purchase">شراء عبر الإنترنت</option>
                        <option value="cash_withdrawal">سحب نقدي (حد 600 شيكل)</option>
                        <option value="installment">تقسيط</option>
                        <option value="salary_payment">دفع راتب</option>
                    </select>
                </div>
                <div id="installmentMonthsGroup" class="hidden">
                    <label for="installmentMonths" class="block text-gray-700 font-medium mb-1">مدة التقسيط (بالأشهر)</label>
                    <select id="installmentMonths" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="6">6 أشهر</option>
                        <option value="12">12 شهر (1 سنة)</option>
                        <option value="18">18 شهر</option>
                        <option value="24">24 شهر (2 سنة)</option>
                        <option value="36">36 شهر (3 سنوات)</option>
                        <option value="48">48 شهر (4 سنوات)</option>
                        <option value="60">60 شهر (5 سنوات)</option>
                    </select>
                </div>
                <div>
                    <label for="transactionAmount" class="block text-gray-700 font-medium mb-1">المبلغ</label>
                    <div class="flex gap-2">
                        <input type="number" id="transactionAmount" step="0.01" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="currencyType" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="USD">دولار</option>
                            <option value="NIS">شيكل</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="transactionDate" class="block text-gray-700 font-medium mb-1">تاريخ الحركة</label>
                    <input type="date" id="transactionDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="transactionDescription" class="block text-gray-700 font-medium mb-1">الوصف</label>
                    <input type="text" id="transactionDescription" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition duration-300 shadow-md">
                    إضافة حركة
                </button>
            </form>
            <div id="messageBox" class="mt-4 p-3 rounded-lg hidden"></div>
        </div>

        <!-- جدول الحركات -->
        <div>
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">سجل الحركات</h2>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-3 px-6 text-gray-700 font-bold uppercase tracking-wider">النوع</th>
                            <th class="py-3 px-6 text-gray-700 font-bold uppercase tracking-wider">الوصف</th>
                            <th class="py-3 px-6 text-gray-700 font-bold uppercase tracking-wider">المبلغ</th>
                            <th class="py-3 px-6 text-gray-700 font-bold uppercase tracking-wider">التاريخ</th>
                            <th class="py-3 px-6 text-gray-700 font-bold uppercase tracking-wider"></th>
                        </tr>
                    </thead>
                    <tbody id="transactionTableBody" class="divide-y divide-gray-200">
                        <!-- سيتم إضافة الحركات هنا بواسطة JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- نافذة تأكيد خصم الأقساط (Modal) -->
    <div id="deductionModal" class="modal-overlay hidden">
        <div class="bg-white p-8 rounded-lg shadow-2xl text-center max-w-sm mx-auto">
            <h3 class="text-xl font-bold mb-4">هل تم خصم الأقساط من راتبك؟</h3>
            <p class="text-gray-700 mb-6">
                إذا كانت الأقساط قد خُصمت، سنقوم بتحديث سجلاتك. إذا لم تكن قد خُصمت، سيتم ترحيل الديون للدورة القادمة.
            </p>
            <div class="flex justify-center gap-4">
                <button id="yesButton" class="bg-green-600 text-white py-2 px-6 rounded-lg font-bold hover:bg-green-700 transition duration-300">
                    نعم
                </button>
                <button id="noButton" class="bg-red-600 text-white py-2 px-6 rounded-lg font-bold hover:bg-red-700 transition duration-300">
                    لا
                </button>
            </div>
        </div>
    </div>

    <div id="messageModal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-lg shadow-2xl text-center max-w-xs mx-auto">
            <p id="messageModalText" class="text-gray-800 text-lg mb-4"></p>
            <button id="messageModalButton" class="bg-blue-600 text-white py-2 px-6 rounded-lg font-bold hover:bg-blue-700 transition duration-300">
                موافق
            </button>
        </div>
    </div>
    
    <script>
        const form = document.getElementById('transactionForm');
        const typeSelect = document.getElementById('transactionType');
        const installmentMonthsGroup = document.getElementById('installmentMonthsGroup');
        const installmentMonthsSelect = document.getElementById('installmentMonths');
        const tableBody = document.getElementById('transactionTableBody');
        const currentCycleDebtEl = document.getElementById('currentCycleDebt');
        const remainingBalanceEl = document.getElementById('remainingBalance');
        const totalInstallmentDebtEl = document.getElementById('totalInstallmentDebt');
        const deductionModal = document.getElementById('deductionModal');
        const yesButton = document.getElementById('yesButton');
        const noButton = document.getElementById('noButton');
        const analyzeButton = document.getElementById('analyzeButton');
        const analysisResult = document.getElementById('analysisResult');
        const analysisText = document.getElementById('analysisText');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageModal = document.getElementById('messageModal');
        const messageModalText = document.getElementById('messageModalText');
        const messageModalButton = document.getElementById('messageModalButton');
        
        const localStorageKey = 'financial_app_transactions';
        const CASH_WITHDRAWAL_LIMIT = 600;
        const INSTALLMENT_COMMISSION_RATE = 0.04;
        const USD_TO_NIS_RATE = 3.75;
        
        let transactions = [];
        let tempSalaryData = null;
        let lastSalaryDate = null;

        // دالة لإظهار مربع الحوار المخصص
        function showMessage(message) {
            messageModalText.textContent = message;
            messageModal.classList.remove('hidden');
        }

        // إغلاق مربع الحوار عند النقر على "موافق"
        messageModalButton.onclick = () => {
            messageModal.classList.add('hidden');
        };

        // إظهار/إخفاء حقل مدة التقسيط
        typeSelect.addEventListener('change', () => {
            if (typeSelect.value === 'installment') {
                installmentMonthsGroup.classList.remove('hidden');
            } else {
                installmentMonthsGroup.classList.add('hidden');
            }
        });

        // تحويل المبلغ إلى شيكل
        function getAmountInNIS(amount, currency) {
            return currency === 'USD' ? amount * USD_TO_NIS_RATE : amount;
        }

        // دالة لحفظ الحركات في الذاكرة المحلية
        function saveToLocalStorage() {
            localStorage.setItem(localStorageKey, JSON.stringify(transactions));
        }

        // دالة لتحديث الأرصدة
        function updateBalances() {
            let cycleDebt = 0;
            let salaryReceived = 0;
            let totalInstallmentDebt = 0;
            
            const salaryPayments = transactions.filter(t => t.type === 'salary_payment').sort((a,b) => new Date(b.date) - new Date(a.date));
            lastSalaryDate = salaryPayments.length > 0 ? new Date(salaryPayments[0].date) : null;
            
            transactions.forEach(t => {
                if (t.type === 'salary_payment') {
                    salaryReceived += getAmountInNIS(t.amount, t.currency);
                } else if (t.type === 'installment' && t.remainingMonths > 0) {
                    totalInstallmentDebt += getAmountInNIS(t.remainingAmount, t.currency);
                } else if (['purchase', 'online_purchase', 'cash_withdrawal'].includes(t.type)) {
                    if (!lastSalaryDate || new Date(t.date) > lastSalaryDate) {
                        cycleDebt += getAmountInNIS(t.amount, t.currency);
                    }
                } else if (t.type === 'installment_payment') {
                     if (!lastSalaryDate || new Date(t.date) > lastSalaryDate) {
                        cycleDebt += getAmountInNIS(t.amount, t.currency);
                    }
                }
            });
            
            const remaining = salaryReceived - cycleDebt;
            
            currentCycleDebtEl.textContent = `${cycleDebt.toFixed(2)} شيكل`;
            remainingBalanceEl.textContent = `${remaining.toFixed(2)} شيكل`;
            totalInstallmentDebtEl.textContent = `${totalInstallmentDebt.toFixed(2)} شيكل`;
            
            if (remaining < 0) {
                remainingBalanceEl.parentElement.classList.remove('bg-red-100', 'bg-green-100');
                remainingBalanceEl.parentElement.classList.add('bg-red-100');
            } else {
                remainingBalanceEl.parentElement.classList.remove('bg-red-100', 'bg-green-100');
                remainingBalanceEl.parentElement.classList.add('bg-green-100');
            }
        }

        // دالة لعرض جميع الحركات في الجدول
        function renderTransactions() {
            tableBody.innerHTML = '';
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            transactions.forEach((t) => {
                const row = document.createElement('tr');
                const isDebt = ['purchase', 'online_purchase', 'cash_withdrawal', 'installment', 'installment_payment'].includes(t.type);
                const isCredit = ['salary_payment'].includes(t.type);
                const amountClass = isDebt ? 'text-red-600' : 'text-green-600';
                const currencySymbol = t.currency === 'USD' ? '$' : 'شيكل';
                
                row.className = `text-gray-700 hover:bg-gray-100 transition-colors duration-200`;
                
                let descriptionText = t.description;
                let displayAmount;

                if (t.type === 'installment' && t.monthlyPayment) {
                    descriptionText += ` (قسط شهري: ${t.monthlyPayment.toFixed(2)} ${currencySymbol})`;
                    displayAmount = t.amount;
                } else {
                    displayAmount = t.amount;
                }
                
                let sign = '';
                if (isDebt) {
                    sign = '-';
                } else if (isCredit) {
                    sign = '+';
                }

                row.innerHTML = `
                    <td class="py-3 px-6 text-sm whitespace-nowrap">${t.typeText}</td>
                    <td class="py-3 px-6 text-sm whitespace-nowrap">${descriptionText}</td>
                    <td class="py-3 px-6 text-sm whitespace-nowrap ${amountClass}">
                        ${sign}${Math.abs(displayAmount).toFixed(2)} ${currencySymbol}
                    </td>
                    <td class="py-3 px-6 text-sm whitespace-nowrap">${new Date(t.date).toLocaleDateString('ar-SY')}</td>
                    <td class="py-3 px-6 text-sm whitespace-nowrap">
                        <button class="text-red-500 hover:text-red-700 transition duration-300" data-doc-id="${t.id}">
                            حذف
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            updateBalances();
        }

        // دالة لحذف حركة
        function deleteTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            saveToLocalStorage();
            renderTransactions();
            showMessage('تم حذف الحركة بنجاح.');
        }

        tableBody.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button && button.dataset.docId) {
                deleteTransaction(button.dataset.docId);
            }
        });
        
        // إضافة الراتب وخصم الأقساط
        function deductInstallmentsAndAddSalary(salaryData) {
            salaryData.id = crypto.randomUUID();
            transactions.push(salaryData);
            
            // Loop through a copy of the transactions array to avoid issues with modification
            const installmentsToUpdate = transactions.filter(t => t.type === 'installment' && t.remainingMonths > 0);

            installmentsToUpdate.forEach(t => {
                // Add a new transaction for the monthly installment payment
                const monthlyPaymentTransaction = {
                    id: crypto.randomUUID(),
                    type: 'installment_payment',
                    typeText: 'دفعة قسط',
                    amount: t.monthlyPayment,
                    description: `دفعة شهرية للقسط: ${t.description}`,
                    date: salaryData.date,
                    currency: t.currency
                };
                transactions.push(monthlyPaymentTransaction);

                // Update the original installment transaction
                t.remainingMonths -= 1;
                t.remainingAmount -= t.monthlyPayment;
            });
            
            saveToLocalStorage();
            renderTransactions();
            showMessage('تم تسجيل دفع الراتب وخصم الأقساط الشهرية.');
        }

        // دالة لإضافة الراتب فقط دون خصم
        function addSalaryOnly(salaryData) {
            salaryData.id = crypto.randomUUID();
            transactions.push(salaryData);
            saveToLocalStorage();
            renderTransactions();
            showMessage('تم تسجيل دفع الراتب دون خصم الأقساط. سيتم ترحيل الديون.');
        }

        // ربط معالجات الأحداث بأزرار مربع الحوار
        yesButton.addEventListener('click', () => {
            deductionModal.classList.add('hidden');
            if(tempSalaryData) {
                deductInstallmentsAndAddSalary(tempSalaryData);
                tempSalaryData = null;
                form.reset();
            }
        });

        noButton.addEventListener('click', () => {
            deductionModal.classList.add('hidden');
            if(tempSalaryData) {
                addSalaryOnly(tempSalaryData);
                tempSalaryData = null;
                form.reset();
            }
        });

        // معالج حدث لإضافة حركة جديدة
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const amountInput = document.getElementById('transactionAmount');
            const descInput = document.getElementById('transactionDescription');
            const type = typeSelect.value;
            const currency = document.getElementById('currencyType').value;
            let amount = parseFloat(amountInput.value);
            const description = descInput.value.trim();
            const typeText = typeSelect.options[typeSelect.selectedIndex].text;
            const transactionDate = document.getElementById('transactionDate').value || new Date().toISOString().substring(0, 10);
            
            if (isNaN(amount) || amount <= 0) {
                showMessage('يرجى إدخال مبلغ صحيح وموجب.');
                return;
            }

            if (type === 'cash_withdrawal' && getAmountInNIS(amount, currency) > CASH_WITHDRAWAL_LIMIT) {
                showMessage(`لا يمكن سحب أكثر من ${CASH_WITHDRAWAL_LIMIT} شيكل نقداً.`);
                return;
            }
            
            let newTransaction = {
                id: crypto.randomUUID(),
                type,
                typeText,
                amount,
                description,
                date: transactionDate,
                currency
            };
            
            if (type === 'installment') {
                const months = parseInt(installmentMonthsSelect.value, 10);
                const totalCommission = amount * INSTALLMENT_COMMISSION_RATE;
                const totalInstallmentAmount = amount + totalCommission;
                const monthlyPayment = totalInstallmentAmount / months;
                
                newTransaction = {
                    ...newTransaction,
                    totalInstallmentAmount: totalInstallmentAmount,
                    totalInstallmentMonths: months,
                    monthlyPayment: monthlyPayment,
                    remainingMonths: months,
                    remainingAmount: totalInstallmentAmount
                };
                transactions.push(newTransaction);
                saveToLocalStorage();
                renderTransactions();
                const currencySymbol = newTransaction.currency === 'USD' ? '$' : 'شيكل';
                showMessage(`تم حساب مبلغ التقسيط الإجمالي: ${totalInstallmentAmount.toFixed(2)} ${currencySymbol}. القسط الشهري: ${monthlyPayment.toFixed(2)} ${currencySymbol}.`);
                form.reset();
            } else if (type === 'salary_payment') {
                tempSalaryData = newTransaction;
                deductionModal.classList.remove('hidden');
            } else {
                transactions.push(newTransaction);
                saveToLocalStorage();
                renderTransactions();
                showMessage(`تم إضافة الحركة بنجاح.`);
                form.reset();
            }
        });

        // دالة للاتصال بـ Gemini لتحليل الإنفاق
        async function analyzeSpendingWithGemini() {
            analysisResult.classList.remove('hidden');
            analysisText.textContent = '';
            loadingIndicator.classList.remove('hidden');

            const currentCycleTransactions = transactions.filter(t => !lastSalaryDate || new Date(t.date) > lastSalaryDate);

            if (currentCycleTransactions.length === 0) {
                analysisText.textContent = 'لا توجد حركات في الدورة الحالية للتحليل.';
                loadingIndicator.classList.add('hidden');
                return;
            }

            const transactionDetails = currentCycleTransactions.map(t => {
                let text = `- ${t.typeText}: ${t.description} (مبلغ: ${t.amount.toFixed(2)} ${t.currency}, تاريخ: ${new Date(t.date).toLocaleDateString('ar-SY')})`;
                if (t.type === 'installment') {
                     text += ` - تقسيط: ${t.monthlyPayment.toFixed(2)} ${t.currency} شهرياً.`;
                }
                return text;
            }).join('\n');

            const prompt = `
            أنا أقوم بإدارة بطاقة مشترياتي، وهذه حركات الدورة المالية الحالية:
            
            ${transactionDetails}

            بصفتك مستشاراً مالياً خبيراً، قدم لي تحليلًا موجزًا وشاملًا لأنماط إنفاقي. أجب باللغة العربية. يجب أن يتضمن التحليل ما يلي:
            1.  تحديد أبرز ثلاثة مجالات للإنفاق (استنادًا إلى "الوصف").
            2.  تقديم نصيحة واحدة قابلة للتنفيذ لتحسين ميزانيتي.
            3.  تقييم عام لحالتي المالية (مثلاً: "جيدة"، "بحاجة إلى تحسين"، "ممتازة").
            
            اجعل الإجابة في فقرة واحدة فقط.`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: "أنت محلل مالي خبير. قدم تحليلًا موجزًا ومباشرًا. يجب أن تكون إجابتك في فقرة واحدة فقط." }]
                },
            };
            
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                let response = null;
                const maxRetries = 3;
                let retryCount = 0;
                while (retryCount < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.status !== 429) {
                            break;
                        }
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount) * 1000));
                        retryCount++;
                    } catch (error) {
                        console.error("Fetch attempt failed:", error);
                        if (retryCount >= maxRetries - 1) throw error;
                        retryCount++;
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount) * 1000));
                    }
                }
                
                if (!response.ok) {
                    throw new Error(`API Error: ${response.statusText}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    analysisText.textContent = text;
                } else {
                    analysisText.textContent = 'عذراً، لم أتمكن من الحصول على تحليل. يرجى المحاولة مرة أخرى.';
                }
            } catch (error) {
                console.error('Failed to get analysis:', error);
                analysisText.textContent = 'حدث خطأ أثناء تحليل بياناتك. يرجى التحقق من اتصالك وإعادة المحاولة.';
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }
        
        // ربط زر التحليل بالدالة
        analyzeButton.addEventListener('click', analyzeSpendingWithGemini);

        // تحميل البيانات الأولية عند تحميل الصفحة
        window.addEventListener('load', () => {
            const storedData = localStorage.getItem(localStorageKey);
            transactions = storedData ? JSON.parse(storedData) : [];
            renderTransactions();
        });
    </script>
</body>
</html>
