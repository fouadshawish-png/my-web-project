<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج المصروفات الشخصية</title>
    <!-- استيراد Tailwind CSS من CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- خط جميل لتجربة أفضل -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 700;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #d1d5db;
        }
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 700;
            transition: all 0.2s;
        }
        .btn-add-income {
            background-color: #10b981;
            color: white;
        }
        .btn-add-expense {
            background-color: #ef4444;
            color: white;
        }
        .btn-pay-debt {
            background-color: #3b82f6;
            color: white;
            padding: 8px 16px;
            font-size: 0.875rem;
        }
        /* تصميم النافذة المنبثقة (Modal) */
        .modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="p-8">
    <div class="max-w-4xl mx-auto space-y-8">
        <!-- العنوان الرئيسي -->
        <header class="text-center">
            <h1 class="text-4xl font-bold text-gray-800">برنامج إدارة المصروفات الشخصية</h1>
            <p class="text-gray-500 mt-2">تتبع دخلك ومصروفاتك اليومية بسهولة</p>
        </header>

        <!-- عرض التاريخ الحالي -->
        <div class="text-center text-lg font-bold text-gray-600">
            <p id="current-date"></p>
        </div>

        <!-- لوحة التحكم الرئيسية -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 text-center">
            <div class="card p-6">
                <h2 class="text-lg font-bold text-gray-600">إجمالي الدخل</h2>
                <p id="total-income" class="text-4xl font-bold text-green-600 mt-2">0</p>
            </div>
            <div class="card p-6">
                <h2 class="text-lg font-bold text-gray-600">إجمالي المصروفات</h2>
                <p id="total-expense" class="text-4xl font-bold text-red-600 mt-2">0</p>
            </div>
            <div class="card p-6">
                <h2 class="text-lg font-bold text-gray-600">الصافي</h2>
                <p id="net-balance" class="text-4xl font-bold text-blue-600 mt-2">0</p>
            </div>
            <div class="card p-6">
                <h2 class="text-lg font-bold text-gray-600">إجمالي الديون</h2>
                <p id="total-debt" class="text-4xl font-bold text-yellow-600 mt-2">0</p>
            </div>
        </div>

        <!-- إضافة معاملة جديدة -->
        <div class="card p-6 space-y-4">
            <h2 class="text-2xl font-bold text-gray-800">إضافة معاملة جديدة</h2>
            
            <!-- صندوق الرسائل -->
            <div id="message-box" class="text-center py-2 px-4 rounded-lg hidden"></div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- حقل المبلغ -->
                <div class="input-group">
                    <label for="amount">المبلغ</label>
                    <input type="number" id="amount" placeholder="أدخل المبلغ" class="focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <!-- حقل الوصف -->
                <div class="input-group">
                    <label for="description">الوصف</label>
                    <input type="text" id="description" placeholder="وصف المعاملة" class="focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
            </div>

            <!-- خيار الدفع -->
            <div class="input-group">
                <label for="payment-type">نوع الدفع</label>
                <select id="payment-type" class="focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="cash">نقداً</option>
                    <option value="credit">دين</option>
                </select>
            </div>

            <!-- حقل الشخص/الجهة (يظهر فقط عند اختيار "دين") -->
            <div id="debtor-name-group" class="input-group hidden">
                <label for="debtor-name">اسم الشخص/الجهة</label>
                <input type="text" id="debtor-name" placeholder="مثال: البقالة، صديق" class="focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div class="flex flex-col md:flex-row gap-4">
                <button id="add-income-btn" class="btn btn-add-income w-full hover:opacity-80">إضافة دخل</button>
                <button id="add-expense-btn" class="btn btn-add-expense w-full hover:opacity-80">إضافة مصروف</button>
            </div>
        </div>

        <!-- ملخص الديون -->
        <div class="card p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">ملخص الديون</h2>
            <div id="debt-summary-list" class="space-y-2">
                <!-- سيتم عرض ملخص الديون هنا بواسطة JavaScript -->
            </div>
        </div>

        <!-- سجل المعاملات -->
        <div class="card p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">سجل المعاملات</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">النوع</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">الوصف</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">المبلغ</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">نوع الدفع</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">الشخص/الجهة</th>
                            <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">التاريخ</th>
                        </tr>
                    </thead>
                    <tbody id="transactions-list" class="bg-white divide-y divide-gray-200">
                        <!-- سيتم إضافة المعاملات هنا بواسطة JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- نافذة سداد الدين المنبثقة (Modal) -->
    <div id="repay-debt-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold mb-4">سداد دين</h3>
            <p id="modal-debtor-name" class="mb-4 text-gray-600"></p>
            <div class="input-group mb-4">
                <label for="repay-amount">المبلغ المراد سداده</label>
                <input type="number" id="repay-amount" placeholder="أدخل المبلغ" class="focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            <div class="flex justify-end space-x-2">
                <button id="cancel-repay-btn" class="btn bg-gray-300 text-gray-800 hover:bg-gray-400">إلغاء</button>
                <button id="confirm-repay-btn" class="btn btn-pay-debt">تأكيد السداد</button>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        // المتغيرات الرئيسية
        const totalIncomeEl = document.getElementById('total-income');
        const totalExpenseEl = document.getElementById('total-expense');
        const netBalanceEl = document.getElementById('net-balance');
        const totalDebtEl = document.getElementById('total-debt');
        const amountInput = document.getElementById('amount');
        const descriptionInput = document.getElementById('description');
        const paymentTypeSelect = document.getElementById('payment-type');
        const debtorNameInput = document.getElementById('debtor-name');
        const debtorNameGroup = document.getElementById('debtor-name-group');
        const addIncomeBtn = document.getElementById('add-income-btn');
        const addExpenseBtn = document.getElementById('add-expense-btn');
        const transactionsListEl = document.getElementById('transactions-list');
        const messageBoxEl = document.getElementById('message-box');
        const debtSummaryListEl = document.getElementById('debt-summary-list');
        const currentDateEl = document.getElementById('current-date');
        
        // متغيرات النافذة المنبثقة
        const repayDebtModal = document.getElementById('repay-debt-modal');
        const modalDebtorNameEl = document.getElementById('modal-debtor-name');
        const repayAmountInput = document.getElementById('repay-amount');
        const confirmRepayBtn = document.getElementById('confirm-repay-btn');
        const cancelRepayBtn = document.getElementById('cancel-repay-btn');

        let transactions = [];
        let currentDebtor = null; // لتخزين اسم الشخص الحالي للسداد

        // دالة لعرض التاريخ الحالي
        function displayCurrentDate() {
            const date = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            currentDateEl.textContent = date.toLocaleDateString('ar-SA', options);
        }

        // دالة لعرض رسالة في صندوق الرسائل
        function showMessage(message, type) {
            messageBoxEl.textContent = message;
            messageBoxEl.classList.remove('hidden');
            messageBoxEl.classList.remove('bg-red-500', 'bg-green-500');

            if (type === 'error') {
                messageBoxEl.classList.add('bg-red-500', 'text-white');
            } else if (type === 'success') {
                messageBoxEl.classList.add('bg-green-500', 'text-white');
            } else {
                messageBoxEl.classList.add('bg-gray-200', 'text-gray-800');
            }
            
            // إخفاء الرسالة بعد 3 ثوانٍ
            setTimeout(() => {
                messageBoxEl.classList.add('hidden');
            }, 3000);
        }

        // دالة لحفظ البيانات باستخدام IPC
        async function saveTransactions() {
            await ipcRenderer.invoke('save-data', transactions);
        }

        // دالة لتحميل البيانات باستخدام IPC
        async function loadTransactions() {
            let loadedTransactions = await ipcRenderer.invoke('load-data');
            transactions = loadedTransactions;
            renderTransactions();
            calculateTotals();
        }

        // دالة لحساب الإجماليات وتحديث العرض
        function calculateTotals() {
            let totalIncome = 0;
            let totalCashExpense = 0;
            const debtSummary = {};

            transactions.forEach(transaction => {
                if (transaction.type === 'income') {
                    totalIncome += transaction.amount;
                } else if (transaction.type === 'expense') {
                    if (transaction.paymentType === 'cash') {
                        totalCashExpense += transaction.amount;
                    } else if (transaction.paymentType === 'credit') {
                        const debtor = transaction.debtor;
                        debtSummary[debtor] = (debtSummary[debtor] || 0) + transaction.amount;
                    }
                } else if (transaction.type === 'repayment') {
                    // سداد الدين هو مصروف نقدي، لذلك يجب إضافته إلى إجمالي المصروفات النقدية
                    totalCashExpense += transaction.amount;
                    const debtor = transaction.debtor;
                    debtSummary[debtor] = (debtSummary[debtor] || 0) - transaction.amount;
                }
            });

            // حساب إجمالي الديون من ملخص الديون
            const totalDebt = Object.values(debtSummary).reduce((sum, current) => sum + current, 0);
            const netBalance = totalIncome - totalCashExpense;

            totalIncomeEl.textContent = `${totalIncome.toFixed(2)}`;
            totalExpenseEl.textContent = `${totalCashExpense.toFixed(2)}`;
            netBalanceEl.textContent = `${netBalance.toFixed(2)}`;
            totalDebtEl.textContent = `${totalDebt.toFixed(2)}`;

            renderDebtSummary(debtSummary);
        }

        // دالة لإضافة معاملة جديدة
        async function addTransaction(type) {
            const amount = parseFloat(amountInput.value);
            const description = descriptionInput.value.trim();
            const paymentType = paymentTypeSelect.value;
            const debtorName = debtorNameInput.value.trim();
            
            if (isNaN(amount) || amount <= 0 || !description) {
                showMessage('الرجاء إدخال مبلغ صحيح ووصف للمعاملة.', 'error');
                return;
            }

            if (paymentType === 'credit' && !debtorName) {
                showMessage('الرجاء إدخال اسم الشخص/الجهة للديون.', 'error');
                return;
            }

            const newTransaction = {
                id: Date.now(),
                type: type,
                amount: amount,
                description: description,
                paymentType: paymentType,
                debtor: paymentType === 'credit' ? debtorName : null,
                date: new Date().toLocaleDateString('ar-SA', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                })
            };

            transactions.unshift(newTransaction);
            await saveTransactions(); // حفظ البيانات بعد الإضافة
            renderTransactions();
            calculateTotals();

            // مسح الحقول بعد الإضافة
            amountInput.value = '';
            descriptionInput.value = '';
            debtorNameInput.value = '';
            showMessage('تم إضافة المعاملة بنجاح!', 'success');
        }

        // دالة لسداد دين
        async function repayDebt(debtorName, amountToPay) {
            if (isNaN(amountToPay) || amountToPay <= 0) {
                 showMessage('الرجاء إدخال مبلغ صحيح لسداد الدين.', 'error');
                 return false;
            }
            
            const newTransaction = {
                id: Date.now(),
                type: 'repayment',
                amount: amountToPay,
                description: `سداد دين لـ ${debtorName}`,
                paymentType: 'cash', // السداد دائماً نقداً
                debtor: debtorName,
                date: new Date().toLocaleDateString('ar-SA', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                })
            };

            transactions.unshift(newTransaction);
            await saveTransactions(); // حفظ البيانات بعد السداد
            renderTransactions();
            calculateTotals();

            showMessage('تم تسجيل سداد الدين بنجاح!', 'success');
            return true;
        }

        // دالة لعرض جميع المعاملات في الجدول
        function renderTransactions() {
            transactionsListEl.innerHTML = ''; // مسح المحتوى الحالي
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                let typeText = '';
                let typeClass = '';
                
                if (transaction.type === 'income') {
                    typeText = 'دخل';
                    typeClass = 'text-green-600';
                } else if (transaction.type === 'expense') {
                    typeText = 'مصروف';
                    typeClass = 'text-red-600';
                } else if (transaction.type === 'repayment') {
                    typeText = 'سداد دين';
                    typeClass = 'text-blue-600';
                }
                
                const paymentTypeText = transaction.paymentType === 'cash' ? 'نقداً' : 'ديناً';
                
                const debtorHtml = transaction.debtor ? transaction.debtor : '-';

                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap"><span class="${typeClass}">${typeText}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap">${transaction.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap font-bold">${transaction.amount.toFixed(2)}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${paymentTypeText}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${debtorHtml}</td>
                    <td class="px-6 py-4 whitespace-nowrap">${transaction.date}</td>
                `;
                transactionsListEl.appendChild(row);
            });
        }
        
        // دالة لعرض ملخص الديون
        function renderDebtSummary(summary) {
            debtSummaryListEl.innerHTML = ''; // مسح المحتوى الحالي
            const keys = Object.keys(summary).sort(); // لترتيب الأسماء أبجدياً

            keys.forEach(debtor => {
                const amount = summary[debtor];
                if (amount > 0) { // عرض فقط الديون المستحقة
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center py-2 px-4 rounded-lg bg-gray-50';
                    div.innerHTML = `
                        <div class="flex-1 font-bold">${debtor}</div>
                        <div class="flex-1 text-red-600 font-bold text-left">${amount.toFixed(2)}</div>
                        <button class="btn btn-pay-debt mr-2" data-debtor="${debtor}">سداد</button>
                    `;
                    debtSummaryListEl.appendChild(div);
                }
            });

            // إضافة مستمعي الأحداث لجميع أزرار السداد
            document.querySelectorAll('.btn-pay-debt').forEach(button => {
                button.addEventListener('click', (e) => {
                    currentDebtor = e.target.getAttribute('data-debtor');
                    modalDebtorNameEl.textContent = `لـ ${currentDebtor}`;
                    repayDebtModal.classList.remove('hidden');
                });
            });
        }

        // إظهار وإخفاء حقل اسم الشخص بناءً على نوع الدفع
        paymentTypeSelect.addEventListener('change', (e) => {
            if (e.target.value === 'credit') {
                debtorNameGroup.classList.remove('hidden');
            } else {
                debtorNameGroup.classList.add('hidden');
            }
        });

        // إضافة مستمعي الأحداث للأزرار
        addIncomeBtn.addEventListener('click', () => addTransaction('income'));
        addExpenseBtn.addEventListener('click', () => addTransaction('expense'));
        
        // إضافة مستمعي أحداث النافذة المنبثقة
        confirmRepayBtn.addEventListener('click', () => {
            const amountToPay = parseFloat(repayAmountInput.value);
            
            if (isNaN(amountToPay) || amountToPay <= 0) {
                 showMessage('الرجاء إدخال مبلغ صحيح لسداد الدين.', 'error');
            } else {
                 repayDebt(currentDebtor, amountToPay);
            }
            
            repayDebtModal.classList.add('hidden');
            repayAmountInput.value = '';
        });

        cancelRepayBtn.addEventListener('click', () => {
            repayDebtModal.classList.add('hidden');
            repayAmountInput.value = '';
        });

        // تحميل البيانات عند بدء التشغيل
        window.onload = async () => {
            displayCurrentDate();
            await loadTransactions();
        };

    </script>
</body>
</html>
