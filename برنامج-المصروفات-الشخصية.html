<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>برنامج المصروفات الشخصية</title>
    <!-- استيراد Tailwind CSS من CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- خط جميل لتجربة أفضل -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            background-color: #fff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        .input-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 700;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }
        .hidden {
            display: none;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
    </style>
</head>
<body class="p-8">

    <div class="max-w-4xl mx-auto space-y-8">
        <!-- قسم الرصيد الحالي والديون -->
        <div class="card p-6 md:p-8 text-center">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">برنامج المصروفات الشخصية</h1>
            <div id="userIdDisplay" class="text-sm text-gray-500 font-mono mb-6"></div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 font-bold text-lg">
                <div class="bg-blue-100 p-4 rounded-lg">
                    <p class="text-blue-800">الرصيد الحالي</p>
                    <p id="currentBalance" class="text-2xl mt-1">0.00 شيكل</p>
                </div>
                <div class="bg-red-100 p-4 rounded-lg">
                    <p class="text-red-800">إجمالي الديون</p>
                    <p id="totalDebt" class="text-2xl mt-1">0.00 شيكل</p>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg">
                    <p class="text-yellow-800">الدين المستحق</p>
                    <p id="totalDueDebt" class="text-2xl mt-1">0.00 شيكل</p>
                </div>
            </div>
        </div>

        <!-- قسم إضافة حركة جديدة -->
        <div class="card p-6 md:p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">إضافة حركة جديدة</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- حقول الإدخال للمصروفات والدخل -->
                <div class="space-y-4">
                    <div class="input-group">
                        <label for="amountInput">المبلغ</label>
                        <input type="number" id="amountInput" placeholder="أدخل المبلغ" required>
                    </div>
                    <div class="input-group">
                        <label for="descriptionInput">الوصف</label>
                        <input type="text" id="descriptionInput" placeholder="أدخل وصفاً للحركة" required>
                    </div>
                    <div class="input-group">
                        <label for="paymentTypeSelect">نوع الدفع</label>
                        <select id="paymentTypeSelect">
                            <option value="cash">نقداً</option>
                            <option value="card">بطاقة</option>
                            <option value="credit">دين</option>
                        </select>
                    </div>
                    <div id="debtorNameGroup" class="input-group hidden">
                        <label for="debtorNameInput">اسم الشخص (المدين)</label>
                        <input type="text" id="debtorNameInput" placeholder="اسم الشخص">
                    </div>
                </div>
                
                <!-- أزرار الإضافة -->
                <div class="flex flex-col space-y-4">
                    <button id="addIncomeBtn" class="bg-green-500 text-white p-4 rounded-lg font-bold hover:bg-green-600 transition">
                        إضافة دخل
                    </button>
                    <button id="addExpenseBtn" class="bg-red-500 text-white p-4 rounded-lg font-bold hover:bg-red-600 transition">
                        إضافة مصروف
                    </button>
                </div>
            </div>
            <div id="messageBox" class="mt-4 p-3 rounded-lg text-white font-bold hidden"></div>
        </div>

        <!-- قسم الديون المستحقة -->
        <div class="card p-6 md:p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">الديون المستحقة</h2>
            <div id="debtsContainer" class="space-y-4">
                <!-- سيتم عرض الديون هنا -->
            </div>
        </div>

        <!-- سجل الحركات -->
        <div class="card p-6 md:p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">سجل الحركات</h2>
            <div id="historyTableContainer" class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg shadow-md">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-sm font-bold uppercase tracking-wider text-right">المبلغ</th>
                            <th class="py-3 px-4 text-sm font-bold uppercase tracking-wider text-right">النوع</th>
                            <th class="py-3 px-4 text-sm font-bold uppercase tracking-wider text-right">الوصف</th>
                            <th class="py-3 px-4 text-sm font-bold uppercase tracking-wider text-right">تاريخ الحركة</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="divide-y divide-gray-200">
                        <!-- سيتم عرض الحركات هنا -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Modal لسداد الدين -->
    <div id="repayDebtModal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <h3 class="text-xl font-bold mb-4">سداد الدين</h3>
            <p id="repayModalText" class="mb-4 text-gray-700"></p>
            <input type="number" id="repayAmountInput" class="w-full p-2 border rounded-lg mb-4" placeholder="أدخل مبلغ السداد">
            <div class="flex justify-center gap-4">
                <button id="confirmRepayBtn" class="bg-green-500 text-white p-3 rounded-lg font-bold hover:bg-green-600">
                    تأكيد
                </button>
                <button id="cancelRepayBtn" class="bg-gray-500 text-white p-3 rounded-lg font-bold hover:bg-gray-600">
                    إلغاء
                </button>
            </div>
        </div>
    </div>

    <!-- Modal للرسائل -->
    <div id="messageModal" class="modal-overlay hidden">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm text-center">
            <p id="messageModalText" class="text-lg font-bold mb-4 text-gray-800"></p>
            <button id="messageModalCloseBtn" class="bg-blue-500 text-white p-3 rounded-lg font-bold hover:bg-blue-600">
                موافق
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        let db;
        let auth;
        let userId = null;
        let transactionsCollection;
        let debtsCollection;

        // UI Elements
        const currentBalanceEl = document.getElementById('currentBalance');
        const totalDebtEl = document.getElementById('totalDebt');
        const totalDueDebtEl = document.getElementById('totalDueDebt');
        const amountInput = document.getElementById('amountInput');
        const descriptionInput = document.getElementById('descriptionInput');
        const paymentTypeSelect = document.getElementById('paymentTypeSelect');
        const debtorNameGroup = document.getElementById('debtorNameGroup');
        const debtorNameInput = document.getElementById('debtorNameInput');
        const addIncomeBtn = document.getElementById('addIncomeBtn');
        const addExpenseBtn = document.getElementById('addExpenseBtn');
        const historyTableBody = document.getElementById('historyTableBody');
        const debtsContainer = document.getElementById('debtsContainer');
        const repayDebtModal = document.getElementById('repayDebtModal');
        const repayModalText = document.getElementById('repayModalText');
        const repayAmountInput = document.getElementById('repayAmountInput');
        const confirmRepayBtn = document.getElementById('confirmRepayBtn');
        const cancelRepayBtn = document.getElementById('cancelRepayBtn');
        const messageModal = document.getElementById('messageModal');
        const messageModalText = document.getElementById('messageModalText');
        const messageModalCloseBtn = document.getElementById('messageModalCloseBtn');
        const userIdDisplay = document.getElementById('userIdDisplay');

        // State
        let transactions = [];
        let debts = [];
        let currentDebtorId = null;

        function showMessage(message, isError = false) {
            messageModalText.textContent = message;
            messageModal.classList.remove('hidden');
        }

        messageModalCloseBtn.onclick = () => {
            messageModal.classList.add('hidden');
        };

        // Utility function to get the current date in YYYY-MM-DD format
        function getCurrentDate() {
            const today = new Date();
            return today.toISOString().substring(0, 10);
        }

        function getTransactionTypeArabic(type) {
            switch(type) {
                case 'income': return 'دخل';
                case 'expense': return 'مصروف';
                case 'debt-repayment': return 'سداد دين';
                default: return type;
            }
        }
        
        function getPaymentTypeArabic(type) {
            switch(type) {
                case 'cash': return 'نقداً';
                case 'card': return 'بطاقة';
                case 'credit': return 'دين';
                default: return type;
            }
        }

        // Render transactions to the history table
        function renderTransactions() {
            historyTableBody.innerHTML = '';
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            transactions.forEach(t => {
                const row = document.createElement('tr');
                const isIncome = t.type === 'income';
                row.className = 'border-b hover:bg-gray-50';
                
                let amountText = `${t.amount.toFixed(2)} شيكل`;
                if (isIncome) {
                    amountText = `<span class="text-green-600">+${amountText}</span>`;
                } else {
                    amountText = `<span class="text-red-600">-${amountText}</span>`;
                }
                
                row.innerHTML = `
                    <td class="py-3 px-4 text-sm">${amountText}</td>
                    <td class="py-3 px-4 text-sm">${getTransactionTypeArabic(t.type)}<br><small class="text-gray-500">(${getPaymentTypeArabic(t.paymentType)})</small></td>
                    <td class="py-3 px-4 text-sm">${t.description}</td>
                    <td class="py-3 px-4 text-sm">${t.date}</td>
                `;
                historyTableBody.appendChild(row);
            });
        }

        // Render debts
        function renderDebts() {
            debtsContainer.innerHTML = '';
            let totalDue = 0;
            debts.forEach(d => {
                const debtDiv = document.createElement('div');
                debtDiv.className = 'bg-red-50 p-4 rounded-lg flex justify-between items-center';
                debtDiv.innerHTML = `
                    <p class="font-bold text-red-800">${d.name}</p>
                    <p class="text-lg font-semibold text-red-700">${d.amount.toFixed(2)} شيكل</p>
                    <button class="repay-btn bg-red-200 text-red-800 font-bold py-1 px-3 rounded-full hover:bg-red-300 transition" data-debtor-id="${d.id}">سداد</button>
                `;
                debtsContainer.appendChild(debtDiv);
                totalDue += d.amount;
            });
            totalDueDebtEl.textContent = `${totalDue.toFixed(2)} شيكل`;
        }

        // Update balances based on all transactions
        function updateBalances() {
            const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
            const totalExpense = transactions.filter(t => t.type === 'expense' || t.type === 'debt-repayment').reduce((sum, t) => sum + t.amount, 0);
            const totalDebt = debts.reduce((sum, d) => sum + d.amount, 0);
            const currentBalance = totalIncome - totalExpense;

            currentBalanceEl.textContent = `${currentBalance.toFixed(2)} شيكل`;
            totalDebtEl.textContent = `${totalDebt.toFixed(2)} شيكل`;
            
            if (currentBalance < 0) {
                currentBalanceEl.parentElement.classList.remove('bg-blue-100');
                currentBalanceEl.parentElement.classList.add('bg-red-100');
            } else {
                currentBalanceEl.parentElement.classList.remove('bg-red-100');
                currentBalanceEl.parentElement.classList.add('bg-blue-100');
            }
        }

        // Add a new transaction
        async function addTransaction(type) {
            const amount = parseFloat(amountInput.value);
            const description = descriptionInput.value.trim();
            const paymentType = paymentTypeSelect.value;
            const debtorName = debtorNameInput.value.trim();

            if (isNaN(amount) || amount <= 0 || !description) {
                showMessage('الرجاء إدخال مبلغ ووصف صحيحين.', true);
                return;
            }

            const newTransaction = {
                amount,
                description,
                paymentType,
                type,
                date: getCurrentDate()
            };

            if (type === 'expense' && paymentType === 'credit') {
                if (!debtorName) {
                    showMessage('الرجاء إدخال اسم الشخص للدين.', true);
                    return;
                }
                const debtRef = await addDoc(debtsCollection, { name: debtorName, amount: amount });
                newTransaction.debtId = debtRef.id;
            }
            
            await addDoc(transactionsCollection, newTransaction);
            showMessage('تم إضافة الحركة بنجاح.');
            amountInput.value = '';
            descriptionInput.value = '';
            debtorNameInput.value = '';
            paymentTypeSelect.value = 'cash';
            debtorNameGroup.classList.add('hidden');
        }

        // Repay a debt
        async function repayDebt(debtId, amountToPay) {
            const debtRef = doc(db, `/artifacts/${appId}/users/${userId}/debts`, debtId);
            const debtSnap = await getDoc(debtRef);

            if (debtSnap.exists()) {
                const currentDebt = debtSnap.data();
                if (amountToPay >= currentDebt.amount) {
                    await deleteDoc(debtRef);
                    await addDoc(transactionsCollection, {
                        amount: currentDebt.amount,
                        description: `سداد دين كامل لـ ${currentDebt.name}`,
                        paymentType: 'cash',
                        type: 'debt-repayment',
                        date: getCurrentDate()
                    });
                    showMessage(`تم سداد الدين لـ ${currentDebt.name} بنجاح.`);
                } else {
                    await updateDoc(debtRef, { amount: currentDebt.amount - amountToPay });
                    await addDoc(transactionsCollection, {
                        amount: amountToPay,
                        description: `سداد جزئي لدين لـ ${currentDebt.name}`,
                        paymentType: 'cash',
                        type: 'debt-repayment',
                        date: getCurrentDate()
                    });
                    showMessage(`تم سداد ${amountToPay} شيكل من دين ${currentDebt.name}.`);
                }
            }
        }

        // Event Listeners
        paymentTypeSelect.addEventListener('change', (e) => {
            if (e.target.value === 'credit') {
                debtorNameGroup.classList.remove('hidden');
            } else {
                debtorNameGroup.classList.add('hidden');
            }
        });

        addIncomeBtn.addEventListener('click', () => addTransaction('income'));
        addExpenseBtn.addEventListener('click', () => addTransaction('expense'));
        
        debtsContainer.addEventListener('click', (e) => {
            const btn = e.target.closest('.repay-btn');
            if (btn) {
                currentDebtorId = btn.dataset.debtorId;
                const debtor = debts.find(d => d.id === currentDebtorId);
                if (debtor) {
                    repayModalText.textContent = `هل تريد سداد دين ${debtor.name} البالغ ${debtor.amount.toFixed(2)} شيكل؟`;
                    repayDebtModal.classList.remove('hidden');
                }
            }
        });

        confirmRepayBtn.addEventListener('click', () => {
            const amountToPay = parseFloat(repayAmountInput.value);
            if (isNaN(amountToPay) || amountToPay <= 0) {
                 showMessage('الرجاء إدخال مبلغ صحيح لسداد الدين.');
            } else {
                 repayDebt(currentDebtorId, amountToPay);
            }
            repayDebtModal.classList.add('hidden');
            repayAmountInput.value = '';
        });

        cancelRepayBtn.addEventListener('click', () => {
            repayDebtModal.classList.add('hidden');
            repayAmountInput.value = '';
        });
        
        // Initial setup
        window.onload = async () => {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userIdDisplay.textContent = `معرف المستخدم: ${userId}`;
                    transactionsCollection = collection(db, `/artifacts/${appId}/users/${userId}/transactions`);
                    debtsCollection = collection(db, `/artifacts/${appId}/users/${userId}/debts`);
                    
                    onSnapshot(transactionsCollection, (snapshot) => {
                        transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderTransactions();
                        updateBalances();
                    });
                    
                    onSnapshot(debtsCollection, (snapshot) => {
                        debts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        renderDebts();
                        updateBalances();
                    });
                } else {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });
        };
    </script>
</body>
</html>
